<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Admin - DT Studio</title>
    <script src="login.js"></script>
</head>
<body>
    <h1>Debug Admin Panel</h1>
    <div id="debug-info">
        <h2>Información de Debug:</h2>
        <div id="session-info"></div>
        <div id="api-info"></div>
        <div id="errors"></div>
    </div>
    
    <button onclick="testSession()">Probar Sesión</button>
    <button onclick="testAPIs()">Probar APIs</button>
    <button onclick="clearAll()">Limpiar Todo</button>
    
    <script>
        let errorCount = 0;
        
        function log(message) {
            console.log(message);
            const errorsDiv = document.getElementById('errors');
            errorsDiv.innerHTML += `<p>${new Date().toISOString()}: ${message}</p>`;
        }
        
        function testSession() {
            log('=== PROBANDO SESIÓN ===');
            
            // Verificar si hay sesión
            const sessionData = localStorage.getItem('adminSession') || sessionStorage.getItem('adminSession');
            log(`Datos de sesión: ${sessionData ? 'Existen' : 'No existen'}`);
            
            if (sessionData) {
                try {
                    const session = JSON.parse(sessionData);
                    log(`Sesión parseada: ${JSON.stringify(session)}`);
                    
                    const loginTime = new Date(session.loginTime);
                    const now = new Date();
                    const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                    log(`Horas desde login: ${hoursDiff}`);
                    
                    if (hoursDiff > 8) {
                        log('Sesión expirada');
                    } else {
                        log('Sesión válida');
                    }
                } catch (error) {
                    log(`Error parseando sesión: ${error.message}`);
                }
            }
            
            // Probar isLoggedIn
            log(`isLoggedIn(): ${isLoggedIn()}`);
            
            // Probar checkAdminSession
            log('Ejecutando checkAdminSession...');
            try {
                checkAdminSession();
                log('checkAdminSession ejecutado sin redirección');
            } catch (error) {
                log(`Error en checkAdminSession: ${error.message}`);
            }
        }
        
        async function testAPIs() {
            log('=== PROBANDO APIs ===');
            
            const apis = [
                'api/dashboard.php?action=get_stats',
                'api/products.php?action=get_products',
                'api/customers.php?action=get_customers'
            ];
            
            for (const api of apis) {
                try {
                    log(`Probando ${api}...`);
                    const response = await fetch(api);
                    log(`Respuesta HTTP: ${response.status} ${response.statusText}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`Datos recibidos: ${JSON.stringify(data).substring(0, 100)}...`);
                    } else {
                        log(`Error HTTP: ${response.status}`);
                    }
                } catch (error) {
                    log(`Error en ${api}: ${error.message}`);
                    errorCount++;
                }
            }
            
            log(`Total errores de API: ${errorCount}`);
        }
        
        function clearAll() {
            localStorage.clear();
            sessionStorage.clear();
            log('Sesiones limpiadas');
        }
        
        // Auto-ejecutar al cargar
        window.addEventListener('load', function() {
            log('Página cargada');
            testSession();
        });
        
        // Detectar recargas
        let reloadCount = 0;
        window.addEventListener('beforeunload', function() {
            reloadCount++;
            log(`Recarga detectada #${reloadCount}`);
        });
    </script>
</body>
</html>
